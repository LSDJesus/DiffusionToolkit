<local:NavigationPage x:Class="Diffusion.Toolkit.Pages.Settings"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
                xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
                xmlns:local="clr-namespace:Diffusion.Toolkit.Pages"
                xmlns:lex="http://wpflocalizeextension.codeplex.com"
                xmlns:toolkit="clr-namespace:Diffusion.Toolkit"
                xmlns:converters="clr-namespace:Diffusion.Toolkit.Converters"
                xmlns:system="clr-namespace:System;assembly=System.Runtime"
                xmlns:models="clr-namespace:Diffusion.Toolkit.Models"
                xmlns:config="clr-namespace:Diffusion.Toolkit.Configuration"
                xmlns:common="clr-namespace:Diffusion.Common;assembly=Diffusion.Common"
                lex:LocalizeDictionary.Provider="{StaticResource LocalizationProvider}"
                lex:LocalizeDictionary.Separation="."
                lex:LocalizeDictionary.DefaultProvider="{StaticResource LocalizationProvider}"
                d:DataContext="{d:DesignInstance models:SettingsModel, IsDesignTimeCreatable = True}"
                mc:Ignorable="d" 
                d:DesignHeight="450" d:DesignWidth="800"
                >
    <local:NavigationPage.Resources>
        <ResourceDictionary>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"></converters:BoolToVisibilityConverter>
            <converters:IsIndexSelectedConverter x:Key="IsIndexSelectedConverter"></converters:IsIndexSelectedConverter>
            <converters:IndexOfConverter x:Key="IndexOfConverter"></converters:IndexOfConverter>
            <converters:NotNullConverter x:Key="NotNullConverter"></converters:NotNullConverter>
        </ResourceDictionary>
    </local:NavigationPage.Resources>
    <Grid Margin="0,0,0,10">
        <Grid.RowDefinitions>
            <RowDefinition Height="38"/>
            <RowDefinition/>
        </Grid.RowDefinitions>

        <TabControl Grid.Row="1" x:Name="TabControl" Padding="10" Margin="5,5,0,0" Background="{DynamicResource PrimaryBrush}">
            <TabControl.Resources>
                <Style  TargetType="{x:Type TabControl}">
                    <Setter Property="OverridesDefaultStyle"
                      Value="True" />
                    <Setter Property="SnapsToDevicePixels"
                      Value="True" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="{x:Type TabControl}">
                                <Grid KeyboardNavigation.TabNavigation="Local">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>
                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup x:Name="CommonStates">
                                            <VisualState x:Name="Disabled">
                                                <Storyboard>
                                                    <ColorAnimationUsingKeyFrames Storyboard.TargetName="Border" Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)">
                                                        <EasingColorKeyFrame KeyTime="0" Value="#FFAAAAAA" />
                                                    </ColorAnimationUsingKeyFrames>
                                                </Storyboard>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>
                                    <TabPanel x:Name="HeaderPanel"
                                        Grid.Row="0"
                                        Panel.ZIndex="1"
                                        Margin="0,0,4,-1"
                                        IsItemsHost="True"
                                        KeyboardNavigation.TabIndex="1"
                                        Background="Transparent" />
                                    <Border x:Name="Border"
                                        Grid.Row="1"
                                        BorderThickness="1"
                                        CornerRadius="2"
                                        KeyboardNavigation.TabNavigation="Local"
                                        KeyboardNavigation.DirectionalNavigation="Contained"
                                        KeyboardNavigation.TabIndex="2">
                                        <!--<Border.Background>
                                            <LinearGradientBrush EndPoint="0.5,1"
                                   StartPoint="0.5,0">
                                                <GradientStop Color="{DynamicResource ContentAreaColorLight}"
                              Offset="0" />
                                                <GradientStop Color="{DynamicResource ContentAreaColorDark}"
                              Offset="1" />
                                            </LinearGradientBrush>
                                        </Border.Background>
                                        <Border.BorderBrush>
                                            <SolidColorBrush Color="{DynamicResource BorderMediumColor}"/>
                                        </Border.BorderBrush>-->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                                            <ContentPresenter x:Name="PART_SelectedContentHost"
                                                              Margin="4"
                                                              ContentSource="SelectedContent" />
                                        </ScrollViewer>

                                    </Border>
                                </Grid>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
                <Style TargetType="{x:Type TabItem}">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="{x:Type TabItem}">
                                <Grid>
                                    <Border Name="Border" Background="{DynamicResource PrimaryBrush}" Margin="2,2,-8,0" BorderBrush="{DynamicResource SecondaryBrush}" BorderThickness="1,1,1,1" CornerRadius="5,5,0,0">
                                        <ContentPresenter x:Name="ContentSite" ContentSource="Header" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="15,4,15,4" RecognizesAccessKey="True" TextBlock.Foreground="{DynamicResource ForegroundBrush}"/>
                                    </Border>
                                </Grid>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="FontWeight" Value="Bold" />
                                        <Setter Property="Panel.ZIndex" Value="10" />
                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource SecondaryBrush}" />
                                    </Trigger>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter TargetName="Border" Property="Background" Value="#FF6E6C67" />
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="true">
                                        <Setter Property="Panel.ZIndex" Value="10" />
                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource SecondaryBrush}" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>

                        </Setter.Value>
                    </Setter>
                    <Setter Property="HeaderTemplate">
                        <Setter.Value>
                            <DataTemplate>
                                <ContentPresenter Content="{TemplateBinding Content}"/>
                            </DataTemplate>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
                </Style>
            </TabControl.Resources>
            <TabItem x:Name="TabItem" Header="{lex:Loc Settings.General}">
                <Grid Margin="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="600"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Width="600" HorizontalAlignment="Left">
                        <Label VerticalContentAlignment="Center" Content="{lex:Loc Settings.General.FoldersInstruction}"></Label>
                        <!--<StackPanel Orientation="Horizontal">
                            <Label VerticalContentAlignment="Center" Content="{lex:Loc Settings.General.DiffusionFolders}"></Label>
                        </StackPanel>
                        <Grid Height="120" VerticalAlignment="Top">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition/>
                                <ColumnDefinition Width="120"/>
                            </Grid.ColumnDefinitions>
                            <ListBox ItemsSource="{Binding ImagePaths}" SelectedIndex="{Binding SelectedIndex}" Margin="0,0,10,0"></ListBox>
                            <StackPanel Grid.Column="1">
                                <Button Click="AddFolder_OnClick" Margin="0,0,0,10" Height="26" Content="{lex:Loc Settings.General.AddFolder}"></Button>
                                <Button Click="RemoveFolder_OnClick" Margin="0,0,0,10" Height="26" Content="{lex:Loc Settings.General.RemoveFolder}" IsEnabled="{Binding SelectedIndex, Converter={StaticResource IsIndexSelectedConverter}}"></Button>
                                <Button Click="ChangeFolderPath_OnClick" Margin="0,0,0,10" Height="26" Content="{lex:Loc Settings.General.ChangeFolderPath}" IsEnabled="{Binding SelectedIndex, Converter={StaticResource IsIndexSelectedConverter}}"></Button>
                            </StackPanel>
                        </Grid>-->
                        <StackPanel Orientation="Vertical" Margin="0,10,0,0">
                            <!--<CheckBox IsChecked="{Binding RecurseFolders}" Margin="0,0,0,10"  VerticalContentAlignment="Center" ToolTip="{lex:Loc Settings.General.Recursive.ToolTip}" Content="{lex:Loc Settings.General.Recursive}"></CheckBox>
                            <CheckBox x:Name="WatchFolders" IsChecked="{Binding WatchFolders}" Margin="0,0,0,10"  ToolTip="{lex:Loc Settings.General.WatchFolders.ToolTip}" Content="{lex:Loc Settings.General.WatchFolders}"></CheckBox>-->
                            <CheckBox IsChecked="{Binding AutoRefresh}" Margin="0,0,0,10" ToolTip="{lex:Loc Settings.General.General.ToolTip}"  Content="{lex:Loc Settings.General.AutoRefresh}"></CheckBox>
                            <CheckBox IsChecked="{Binding ScanForNewImagesOnStartup}" Margin="0,0,0,10" Content="{lex:Loc Settings.Images.ScanForNewImagesOnStartup}"></CheckBox>
                        </StackPanel>
                        <!--<Label Content="{lex:Loc Settings.General.ExcludedFolders}"></Label>
                        <Grid Height="100">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition/>
                                <ColumnDefinition Width="120"/>
                            </Grid.ColumnDefinitions>
                            <ListBox ItemsSource="{Binding ExcludePaths}" SelectedIndex="{Binding ExcludedSelectedIndex}" Grid.RowSpan="2" Margin="0,0,10,0"></ListBox>
                            <StackPanel Grid.Column="1">
                                <Button Click="ExcludedAddFolder_OnClick" Margin="0,0,0,10" Height="26" Content="{lex:Loc Settings.General.AddFolder}"></Button>
                                <Button Click="ExcludedRemoveFolder_OnClick" Margin="0,0,0,10" Height="26" Content="{lex:Loc Settings.General.RemoveFolder}" IsEnabled="{Binding ExcludedSelectedIndex, Converter={StaticResource IsIndexSelectedConverter}}"></Button>
                            </StackPanel>

                        </Grid>-->
                        <Label Content="{lex:Loc Settings.General.FileExtensions}"></Label>
                        <Grid >
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition/>
                                <ColumnDefinition Width="120"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Height="26" VerticalContentAlignment="Center" Text="{Binding FileExtensions, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,10,0"></TextBox>
                        </Grid>

                        <CheckBox IsChecked="{Binding CheckForUpdatesOnStartup}" Margin="0,10,0,0" Content="{lex:Loc Settings.General.CheckForUpdatesOnStartup}"></CheckBox>

                        <CheckBox IsChecked="{Binding PortableMode}" Margin="0,10,0,0" Content="{lex:Loc Settings.General.PortableMode}"></CheckBox>

                        <CheckBox IsChecked="{Binding SoftwareOnly}" Margin="0,10,0,0" Content="{lex:Loc Settings.General.SoftwareOnly}"></CheckBox>

                    </StackPanel>
                </Grid>

            </TabItem>
            <TabItem Header="{lex:Loc Settings.Models}">
                <StackPanel Width="800" HorizontalAlignment="Left" Margin="10">
                    <Label Content="{lex:Loc Settings.Models.ModelsRoot}"></Label>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="120"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Height="26" VerticalContentAlignment="Center" Text="{Binding ModelRootPath, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,10,0"></TextBox>
                        <Button Height="26" Grid.Column="1" Click="BrowseModelPath_OnClick" Content="{lex:Loc Common.Buttons.Browse}"></Button>
                    </Grid>
                    <TextBlock Foreground="{DynamicResource ForegroundBrush}" Margin="10" TextWrapping="Wrap" Text="{lex:Loc Settings.Models.ModelsRoot.Description}">
                    </TextBlock>
                    
                    <Label Content="{lex:Loc Settings.Models.ExpectedSubfolders}" Margin="0,10,0,0"></Label>
                    <TextBlock Foreground="{DynamicResource SecondaryForegroundBrush}" Margin="10,5,10,10" TextWrapping="Wrap" FontSize="12">
                        The Models Root should contain subdirectories for different model types:
                        • checkpoints (or Stable-diffusion)
                        • loras (LoRA/LyCORIS models)
                        • embeddings (textual inversions)
                        • diffusion_models (diffusion model files)
                        • unet (UNet models)
                        • upscale_models (ESRGAN, etc.)
                        • vae (VAE models)
                        • controlnet (ControlNet models)
                    </TextBlock>
                    
                    <Button Height="26" Width="150" HorizontalAlignment="Left" Margin="0,10,0,0" 
                            Click="ScanModels_OnClick" Content="{lex:Loc Settings.Models.ScanModels}"></Button>
                </StackPanel>
            </TabItem>
            <TabItem Header="{lex:Loc Settings.Images}">
                <StackPanel  Width="800" HorizontalAlignment="Left" Margin="10">
                    <Label Content="{lex:Loc Settings.Images.ThumbnailsPerPage}"></Label>
                    <Grid HorizontalAlignment="Stretch">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="120"/>
                        </Grid.ColumnDefinitions>
                        <Slider x:Name="Slider" Minimum="100" Maximum="1000" Value="{Binding PageSize}" TickFrequency="50" IsSnapToTickEnabled="True" TickPlacement="BottomRight" Orientation="Horizontal" Margin="0,0,10,0"></Slider>
                        <Label Grid.Column="1" Height="26" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Content="{Binding PageSize}" Margin="0,0,10,0"></Label>
                    </Grid>
                    <Label Content="{lex:Loc Settings.Images.OpenImagesUsing}"/>
                    <Grid Margin="0,10,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <RadioButton GroupName="Viewer" IsChecked="{Binding UseBuiltInViewer}" Content="{lex:Loc Settings.Images.OpenImagesUsing.BuiltInViewer}"></RadioButton>
                        <CheckBox IsEnabled="{Binding UseBuiltInViewer}" Grid.Column="1" IsChecked="{Binding OpenInFullScreen}" Content="{lex:Loc Settings.Images.OpenImagesUsing.BuiltInViewer.OpenInFullscreen}"></CheckBox>
                    </Grid>
                    <RadioButton GroupName="Viewer" IsChecked="{Binding UseSystemDefault}" Margin="0,10,0,0" Content="{lex:Loc Settings.Images.OpenImagesUsing.SystemDefault}"></RadioButton>
                    <Grid Margin="0,10,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="30"/>
                        </Grid.ColumnDefinitions>
                        <RadioButton GroupName="Viewer" IsChecked="{Binding UseCustomViewer}" Content="{lex:Loc Settings.Images.OpenImagesUsing.Custom}"></RadioButton>
                        <TextBox IsEnabled="{Binding UseCustomViewer}" Grid.Column="1" Text="{Binding CustomCommandLine}"></TextBox>
                        <Button IsEnabled="{Binding UseCustomViewer}" Grid.Column="2" Click="BrowseCustomViewer_OnClick">...</Button>
                    </Grid>
                    <Grid Margin="0,10,0,0" IsEnabled="{Binding UseCustomViewer}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="30"/>
                        </Grid.ColumnDefinitions>
                        <Label Content="{lex:Loc Settings.Images.OpenImagesUsing.Custom.Arguments}"></Label>
                        <TextBox Grid.Column="1" Height="20"  Text="{Binding CustomCommandLineArgs}"></TextBox>
                    </Grid>
                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0" >
                        <Label>Slide show delay (seconds)</Label>
                        <TextBox Text="{Binding SlideShowDelay, UpdateSourceTrigger=PropertyChanged}" Height="20" Width="50"></TextBox>
                    </StackPanel>
                    <CheckBox IsChecked="{Binding AdvanceOnTag}" Margin="0,10,0,0" Content="{lex:Loc Settings.Images.AdvanceOnTag}"></CheckBox>
                    <CheckBox IsChecked="{Binding ScrollNavigation}" Margin="0,10,0,0" Content="{lex:Loc Settings.Images.ScrollNavigation}"></CheckBox>
                    <CheckBox IsChecked="{Binding ShowFilenames}" Margin="0,10,0,0" Content="{lex:Loc Settings.Images.ShowFilenames}"></CheckBox>
                    <CheckBox IsChecked="{Binding PermanentlyDelete}" Margin="0,10,0,0" Content="{lex:Loc Settings.Images.PermanentlyDelete}"></CheckBox>
                    <CheckBox IsChecked="{Binding ConfirmDeletion}" Margin="0,10,0,0" Content="{lex:Loc Settings.Images.ConfirmDeletion}"></CheckBox>
                </StackPanel>
            </TabItem>
            <TabItem Header="{lex:Loc Settings.Metadata}">
                <StackPanel Width="800" HorizontalAlignment="Left" Margin="10">
                    <CheckBox IsChecked="{Binding StoreMetadata}" Margin="0,10,0,0" Content="{lex:Loc Settings.Metadata.StoreMetadata}"></CheckBox>
                    <CheckBox IsChecked="{Binding StoreWorkflow}" Margin="0,10,0,0" Content="{lex:Loc Settings.Metadata.StoreWorkflow}"></CheckBox>
                    <TextBlock Foreground="{DynamicResource ForegroundBrush}" Margin="0,10,0,0" TextWrapping="Wrap" Text="{lex:Loc Settings.Metadata.Warning}"></TextBlock>
                </StackPanel>
            </TabItem>
            <TabItem Header="{lex:Loc Settings.NSFW}">
                <StackPanel Width="400" HorizontalAlignment="Left" Margin="10">
                    <Label Content="{lex:Loc Settings.NSFW.NSFWTags}"></Label>
                    <TextBox Padding="5" Text="{Binding NSFWTags, UpdateSourceTrigger=PropertyChanged}" VerticalScrollBarVisibility="Auto" AcceptsReturn="True" Margin="0,10,0,10" Height="200"></TextBox>
                    <CheckBox IsChecked="{Binding AutoTagNSFW}" ToolTip="Automatically tag added images as NSFW" Content="{lex:Loc Settings.NSFW.AutoTagNSFW}"></CheckBox>
                </StackPanel>
            </TabItem>
            <TabItem Header="{lex:Loc Settings.Themes}">
                <StackPanel Width="400" HorizontalAlignment="Left" Margin="10">
                    <Label Content="{lex:Loc Settings.Themes.Theme}"></Label>
                    <Grid >
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="120"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox Height="26" VerticalContentAlignment="Center" 
                                      ItemsSource="{Binding ThemeOptions}"
                                      SelectedValue="{Binding Theme}"
                                      DisplayMemberPath="Name"
                                      SelectedValuePath="Value" Margin="0,0,10,0">
                        </ComboBox>
                    </Grid>

                    <Label Content="{lex:Loc Settings.Themes.Language}"/>
                    <Grid >
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="120"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox ItemsSource="{Binding Cultures}" DisplayMemberPath="Name" SelectedValuePath="Culture" SelectedValue="{Binding Culture}" Height="26" VerticalContentAlignment="Center"  Margin="0,0,10,0">
                        </ComboBox>
                    </Grid>
                </StackPanel>
            </TabItem>
            <TabItem x:Name="ExternalApplicationsTab" Header="{lex:Loc Settings.ExternalApplications}">
                <Grid Margin="10">
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="250"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <ListBox ItemsSource="{Binding ExternalApplications}" DisplayMemberPath="Name" SelectedItem="{Binding SelectedApplication}">
                        </ListBox>
                        <StackPanel Margin="10,0,0,0" Grid.Column="1" >
                            <Button Height="26" Margin="0,0,0,10" Click="AddExternalApplication_OnClick" Content="{lex:Loc Settings.ExternalApplications.Add}"></Button>
                            <Button Height="26" Margin="0,0,0,10" IsEnabled="{Binding SelectedApplication, Converter={StaticResource NotNullConverter}}" Click="RemoveExternalApplication_OnClick" Content="{lex:Loc Settings.ExternalApplications.Remove}"></Button>
                            <Button Height="26" Margin="0,0,0,10" IsEnabled="{Binding SelectedApplication, Converter={StaticResource NotNullConverter}}" Click="MoveExternalApplicationUp_OnClick" Content="{lex:Loc Settings.ExternalApplications.MoveUp}"></Button>
                            <Button Height="26" IsEnabled="{Binding SelectedApplication, Converter={StaticResource NotNullConverter}}" Click="MoveExternalApplicationDown_OnClick" Content="{lex:Loc Settings.ExternalApplications.MoveDown}"></Button>
                        </StackPanel>
                        <StackPanel Margin="30,0,0,0"  HorizontalAlignment="Left" Grid.Column="2" IsEnabled="{Binding SelectedApplication, Converter={StaticResource NotNullConverter}}">
                            <Label>Application Name</Label>
                            <TextBox Margin="0,0,0,5" Height="26" VerticalContentAlignment="Center" Text="{Binding SelectedApplication.Name}"></TextBox>
                            <Label>Application Path</Label>
                            <Grid Margin="0,0,0,5" >
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Height="26" VerticalContentAlignment="Center" Text="{Binding SelectedApplication.Path}"></TextBox>
                                <Button Height="26" Grid.Column="1" Click="BrowseExternalApplicationPath_OnClick" Content="{lex:Loc Common.Buttons.Browse}"></Button>
                            </Grid>
                            <Label>Command line arguments</Label>
                            <TextBox Height="26" Margin="0,0,0,5" VerticalContentAlignment="Center" Text="{Binding SelectedApplication.CommandLineArgs}"></TextBox>
                            <StackPanel Margin="0,0,0,5" Orientation="Horizontal">
                                <Label>Shortcut:</Label>
                                <Label Content="{Binding SelectedApplication.Shortcut}"></Label>
                            </StackPanel>
                            <RichTextBox Width="600" HorizontalAlignment="Left" Foreground="{DynamicResource ForegroundBrush}" BorderBrush="Transparent" Margin="5" Background="Transparent" IsHitTestVisible="False">
                                <FlowDocument>
                                    <Paragraph>
                                        Use %1 to pass the file path. If empty, it will default to %1.
                                    </Paragraph>
                                    <Paragraph>
                                        Filenames will automatically be enclosed in double quotes.
                                    </Paragraph>
                                    <Paragraph>
                                        Multiple selected files will be sent as multiple arguments separated by spaces. e.g.:
                                    </Paragraph>
                                    <Paragraph Margin="10" FontFamily="Consolas">
                                        "Image001.png" "Image002.png" "Image003.png"
                                    </Paragraph>
                                    <Paragraph>
                                        If unsure, leave empty.
                                    </Paragraph>
                                </FlowDocument>
                            </RichTextBox>
                        </StackPanel>

                    </Grid>
                </Grid>


            </TabItem>
            <TabItem Header="Tagging &amp; Captioning">
                <StackPanel Width="800" HorizontalAlignment="Left" Margin="10">
                    
                    <!-- Global GPU Settings -->
                    <GroupBox Header="GPU Settings" Margin="0,0,0,15" Padding="10" Foreground="{DynamicResource ForegroundBrush}">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,10" Opacity="0.8" FontSize="11"
                                       Foreground="{DynamicResource ForegroundBrush}">
                                Configure GPU resources shared by all processing pipelines (tagging, captioning, embedding, face detection).
                                The system automatically distributes work across GPUs and manages VRAM efficiently.
                            </TextBlock>
                            
                            <!-- New Processing Architecture Toggle -->
                            <CheckBox Content="Use New Processing Architecture (Experimental)" 
                                      IsChecked="{Binding UseNewProcessingArchitecture}"
                                      Margin="0,0,0,15"
                                      ToolTip="Enable the new modular processing orchestrator. More efficient GPU utilization and better progress tracking. Restart required after changing."
                                      Foreground="{DynamicResource ForegroundBrush}"/>
                            
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <Label Grid.Row="0" Grid.Column="0" Content="GPU Devices:" 
                                       ToolTip="CUDA device IDs (e.g., '0' for single GPU, '0,1' for dual GPU)"
                                       Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding GpuDevices, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="120" Height="26" VerticalContentAlignment="Center" HorizontalAlignment="Left"
                                         ToolTip="Enter device IDs: 0, or 0,1"/>
                                
                                <Label Grid.Row="1" Grid.Column="0" Content="VRAM Capacity (GB):" 
                                       ToolTip="Available VRAM per GPU (e.g., '32' or '32,10' for 32GB + 10GB)"
                                       Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding GpuVramCapacity, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="120" Height="26" VerticalContentAlignment="Center" HorizontalAlignment="Left"
                                         ToolTip="Enter VRAM in GB: 32, or 32,10"/>
                                
                                <Label Grid.Row="2" Grid.Column="0" Content="Max VRAM Usage:" 
                                       ToolTip="Maximum percentage of VRAM to use (50-95%). Leave headroom for stability."
                                       Foreground="{DynamicResource ForegroundBrush}"/>
                                <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal">
                                    <Slider Width="150" Minimum="50" Maximum="95" Value="{Binding MaxVramUsagePercent}" 
                                            TickFrequency="5" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <Label Content="{Binding MaxVramUsagePercent, StringFormat={}{0}%}" Margin="10,0,0,0" 
                                           VerticalAlignment="Center" Foreground="{DynamicResource ForegroundBrush}"/>
                                </StackPanel>
                            </Grid>
                            
                            <!-- GPU Model Allocation Calculator -->
                            <TextBlock Text="GPU Model Allocation" FontWeight="SemiBold" Margin="0,15,0,5" Foreground="{DynamicResource ForegroundBrush}"/>
                            <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource ForegroundBrush}" Margin="0,0,0,10" FontSize="11">
                                Configure how many model instances to load per GPU. Use comma-separated values matching your GPU order.
                                Example: "1,1" means 1 model on GPU0, 1 on GPU1. VRAM per model: Captioning=5.8GB, Tagging=3.1GB, Embedding=7.5GB, FaceDetect=0.8GB
                            </TextBlock>
                            
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="200"/>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Headers -->
                                <Label Grid.Row="0" Grid.Column="0" Content="" Foreground="{DynamicResource ForegroundBrush}"/>
                                <Label Grid.Row="0" Grid.Column="1" Content="Concurrent" FontWeight="Bold" 
                                       ToolTip="Models to load when running all processes together"
                                       Foreground="{DynamicResource ForegroundBrush}" HorizontalAlignment="Center"/>
                                <Label Grid.Row="0" Grid.Column="3" Content="Solo" FontWeight="Bold"
                                       ToolTip="Models to load when running a single process alone"
                                       Foreground="{DynamicResource ForegroundBrush}" HorizontalAlignment="Center"/>
                                
                                <!-- Captioning Row -->
                                <Label Grid.Row="1" Grid.Column="0" Content="Captioning (5.8GB each):" 
                                       Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="1" 
                                         Text="{Binding ConcurrentCaptioningAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                                <TextBox Grid.Row="1" Grid.Column="3" 
                                         Text="{Binding SoloCaptioningAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                                
                                <!-- Tagging Row -->
                                <Label Grid.Row="2" Grid.Column="0" Content="Tagging (3.1GB each):" 
                                       Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="2" Grid.Column="1" 
                                         Text="{Binding ConcurrentTaggingAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                                <TextBox Grid.Row="2" Grid.Column="3" 
                                         Text="{Binding SoloTaggingAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                                
                                <!-- Embedding Row -->
                                <Label Grid.Row="3" Grid.Column="0" Content="Embedding (7.5GB each):" 
                                       Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="3" Grid.Column="1" 
                                         Text="{Binding ConcurrentEmbeddingAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                                <TextBox Grid.Row="3" Grid.Column="3" 
                                         Text="{Binding SoloEmbeddingAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                                
                                <!-- Face Detection Row -->
                                <Label Grid.Row="4" Grid.Column="0" Content="Face Detection (0.8GB each):" 
                                       Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="4" Grid.Column="1" 
                                         Text="{Binding ConcurrentFaceDetectionAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                                <TextBox Grid.Row="4" Grid.Column="3" 
                                         Text="{Binding SoloFaceDetectionAllocation, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="80" Height="24" VerticalContentAlignment="Center" HorizontalAlignment="Center"/>
                            </Grid>
                            
                            <!-- Calculate Button and Results -->
                            <StackPanel Orientation="Horizontal" Margin="0,5,0,10">
                                <Button Content="Calculate VRAM" Click="CalculateVram_Click" Padding="15,5" 
                                        ToolTip="Check if your allocation fits within available VRAM"/>
                            </StackPanel>
                            
                            <Grid Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Concurrent Results -->
                                <StackPanel Grid.Column="0" Margin="0,0,20,0">
                                    <TextBlock Text="Concurrent Mode (All Together):" FontWeight="SemiBold" 
                                               Foreground="{DynamicResource ForegroundBrush}" Margin="0,0,0,5"/>
                                    <TextBlock Text="{Binding ConcurrentVramResult}" 
                                               Foreground="{DynamicResource ForegroundBrush}" 
                                               FontFamily="Consolas" TextWrapping="Wrap"/>
                                </StackPanel>
                                
                                <!-- Solo Results -->
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Solo Mode (One Process Only):" FontWeight="SemiBold" 
                                               Foreground="{DynamicResource ForegroundBrush}" Margin="0,0,0,5"/>
                                    <TextBlock Text="{Binding SoloVramResults}" 
                                               Foreground="{DynamicResource ForegroundBrush}" 
                                               FontFamily="Consolas" TextWrapping="Wrap"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </GroupBox>
                    
                    <GroupBox Header="Auto-Tagging Settings" Margin="0,0,0,15" Padding="10" Foreground="{DynamicResource ForegroundBrush}">
                        <StackPanel>
                            <!-- JoyTag Settings -->
                            <CheckBox IsChecked="{Binding EnableJoyTag}" Content="Enable JoyTag" Margin="0,5,0,5" FontWeight="Bold" Foreground="{DynamicResource ForegroundBrush}"/>
                            <Grid Margin="20,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="150"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <Label Grid.Row="0" Grid.Column="0" Content="Confidence Threshold:" Foreground="{DynamicResource ForegroundBrush}"/>
                                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                                    <Slider Width="200" Minimum="0" Maximum="1" Value="{Binding JoyTagThreshold}" 
                                            TickFrequency="0.05" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <Label Content="{Binding JoyTagThreshold, StringFormat=F2}" Margin="10,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundBrush}"/>
                                </StackPanel>
                                
                                <Label Grid.Row="1" Grid.Column="0" Content="Model Path:" Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding JoyTagModelPath}" Height="26" VerticalContentAlignment="Center"/>
                                
                                <Label Grid.Row="2" Grid.Column="0" Content="Tags CSV Path:" Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding JoyTagTagsPath}" Height="26" VerticalContentAlignment="Center"/>
                            </Grid>

                            <!-- WD v3 Large Settings -->
                            <CheckBox IsChecked="{Binding EnableWDV3Large}" Content="Enable WD v3 Large (Multi-label ONNX - Booru Tags)" Margin="0,10,0,5" FontWeight="Bold" Foreground="{DynamicResource ForegroundBrush}"/>
                            <Grid Margin="20,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="150"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <Label Grid.Row="0" Grid.Column="0" Content="Confidence Threshold:" Foreground="{DynamicResource ForegroundBrush}"/>
                                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                                    <Slider Width="200" Minimum="0" Maximum="1" Value="{Binding WDV3LargeThreshold}" 
                                            TickFrequency="0.05" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <Label Content="{Binding WDV3LargeThreshold, StringFormat=F2}" Margin="10,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundBrush}"/>
                                </StackPanel>
                                
                                <Label Grid.Row="1" Grid.Column="0" Content="Model Path:" Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding WDV3LargeModelPath}" Height="26" VerticalContentAlignment="Center"/>
                                
                                <Label Grid.Row="2" Grid.Column="0" Content="Tags CSV Path:" Foreground="{DynamicResource ForegroundBrush}"/>
                                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding WDV3LargeTagsPath}" Height="26" VerticalContentAlignment="Center"/>
                            </Grid>

                            <!-- Tag Storage Options -->
                            <CheckBox IsChecked="{Binding StoreTagConfidence}" Content="Store confidence values with tags" 
                                      Margin="0,10,0,5" ToolTip="When enabled, tags will be saved with their confidence scores (e.g., 'cat: 0.95')"
                                      Foreground="{DynamicResource ForegroundBrush}"/>
                            
                            <!-- Performance Settings -->
                            <Separator Margin="0,15,0,15"/>
                            <TextBlock Text="Processing Options" FontWeight="Bold" Margin="0,0,0,10" Foreground="{DynamicResource ForegroundBrush}"/>
                            
                            <CheckBox IsChecked="{Binding SkipAlreadyTaggedImages}" 
                                      Content="Skip images that already have tags" 
                                      Margin="0,0,0,10"
                                      ToolTip="When enabled, images with existing tags will be skipped during bulk tagging operations"
                                      Foreground="{DynamicResource ForegroundBrush}"/>
                            
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="Image Captioning Settings" Padding="10" Foreground="{DynamicResource ForegroundBrush}">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="150"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <Label Grid.Row="0" Grid.Column="0" Content="Default Prompt:" Foreground="{DynamicResource ForegroundBrush}"/>
                                <ComboBox Grid.Row="0" Grid.Column="1" SelectedValue="{Binding JoyCaptionDefaultPrompt}" 
                                          SelectedValuePath="Tag"
                                          Height="26" VerticalContentAlignment="Center">
                                    <ComboBoxItem Content="Detailed Description (150-200 words)" Tag="detailed"/>
                                    <ComboBoxItem Content="Short (Single sentence)" Tag="short"/>
                                    <ComboBoxItem Content="Technical Analysis" Tag="technical"/>
                                    <ComboBoxItem Content="Precise Colors" Tag="precise_colors"/>
                                    <ComboBoxItem Content="Character Focus" Tag="character"/>
                                    <ComboBoxItem Content="Scene Focus" Tag="scene"/>
                                    <ComboBoxItem Content="Artistic Style" Tag="artistic"/>
                                    <ComboBoxItem Content="Booru-style Tags" Tag="booru"/>
                                </ComboBox>

                                <Label Grid.Row="1" Grid.Column="0" Content="Caption Handling:" Margin="0,10,0,0" Foreground="{DynamicResource ForegroundBrush}"/>
                                <ComboBox Grid.Row="1" Grid.Column="1" SelectedValue="{Binding CaptionHandlingMode}" 
                                          Height="26" VerticalContentAlignment="Center" Margin="0,10,0,0"
                                          SelectedValuePath="Tag"
                                          ToolTip="How to handle existing captions when generating new ones">
                                    <ComboBoxItem Content="Overwrite - Replace existing caption" Tag="{x:Static common:CaptionHandlingMode.Overwrite}"/>
                                    <ComboBoxItem Content="Append - Add to existing caption" Tag="{x:Static common:CaptionHandlingMode.Append}"/>
                                    <ComboBoxItem Content="Refine - Use existing as context for improvement" Tag="{x:Static common:CaptionHandlingMode.Refine}"/>
                                </ComboBox>

                                <Label Grid.Row="2" Grid.Column="0" Content="Provider:" Margin="0,10,0,0" Foreground="{DynamicResource ForegroundBrush}"/>
                                <ComboBox Grid.Row="2" Grid.Column="1" SelectedValue="{Binding CaptionProvider}"
                                          Height="26" VerticalContentAlignment="Center" Margin="0,10,0,0"
                                          SelectedValuePath="Tag">
                                    <ComboBoxItem Content="Local JoyCaption (LLava GGUF)" Tag="{x:Static common:CaptionProviderType.LocalJoyCaption}"/>
                                    <ComboBoxItem Content="OpenAI-Compatible HTTP API" Tag="{x:Static common:CaptionProviderType.OpenAICompatible}"/>
                                </ComboBox>
                                
                                <!-- Local JoyCaption configuration -->
                                <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2">
                                    <Grid.Style>
                                        <Style TargetType="Grid">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding CaptionProvider}" Value="{x:Static common:CaptionProviderType.LocalJoyCaption}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Grid.Style>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Label Grid.Row="0" Grid.Column="0" Content="Model Path:" Foreground="{DynamicResource ForegroundBrush}"/>
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding JoyCaptionModelPath}" Height="26" VerticalContentAlignment="Center"/>
                                    <Label Grid.Row="1" Grid.Column="0" Content="MMProj Path:" Foreground="{DynamicResource ForegroundBrush}"/>
                                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding JoyCaptionMMProjPath}" Height="26" VerticalContentAlignment="Center"/>
                                </Grid>

                                <!-- External OpenAI-compatible HTTP provider configuration -->
                                <Grid Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2">
                                    <Grid.Style>
                                        <Style TargetType="Grid">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding CaptionProvider}" Value="{x:Static common:CaptionProviderType.OpenAICompatible}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Grid.Style>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Label Grid.Row="0" Grid.Column="0" Content="Base URL:" Foreground="{DynamicResource ForegroundBrush}"/>
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding ExternalCaptionBaseUrl}" Height="26" VerticalContentAlignment="Center"/>
                                    <Label Grid.Row="1" Grid.Column="0" Content="Model:" Foreground="{DynamicResource ForegroundBrush}"/>
                                    <ComboBox Grid.Row="1" Grid.Column="1" Height="26" IsEditable="True" 
                                              Text="{Binding ExternalCaptionModel, UpdateSourceTrigger=PropertyChanged}"
                                              ItemsSource="{Binding AvailableModels}"/>
                                    <Label Grid.Row="2" Grid.Column="0" Content="API Key:" Foreground="{DynamicResource ForegroundBrush}"/>
                                    <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding ExternalCaptionApiKey}" Height="26" VerticalContentAlignment="Center"/>
                                    <StackPanel Grid.Row="3" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,10,0,0">
                                        <Button Width="160" Height="26" HorizontalAlignment="Left" Click="TestCaptionApi_Click">Test Connection</Button>
                                        <Button Width="220" Height="26" HorizontalAlignment="Left" Margin="10,0,0,0" Click="TestCaptionApiWithImage_Click">Send Sample Image</Button>
                                    </StackPanel>
                                </Grid>

                                <TextBlock Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2" 
                                           TextWrapping="Wrap" Margin="0,10,0,0" Opacity="0.7" FontSize="11"
                                           Foreground="{DynamicResource ForegroundBrush}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding CaptionProvider}" Value="{x:Static common:CaptionProviderType.LocalJoyCaption}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                    Note: JoyCaption requires significant VRAM (~8GB per model). The GPU orchestrator will automatically manage model loading.
                                </TextBlock>
                            </Grid>
                            
                            <!-- Captioning Processing Settings -->
                            <TextBlock Text="Processing Options" FontWeight="SemiBold" Margin="0,20,0,10" FontSize="12"
                                      Foreground="{DynamicResource ForegroundBrush}"/>
                            
                            <CheckBox IsChecked="{Binding SkipAlreadyCaptionedImages}" 
                                      Content="Skip images that already have captions" 
                                      Margin="0,0,0,10"
                                      ToolTip="Skip images that already have captions in the database"
                                      Foreground="{DynamicResource ForegroundBrush}"/>
                            
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="Metadata Writing" Margin="0,15,0,0" Padding="10">
                        <StackPanel>
                            <CheckBox IsChecked="{Binding AutoWriteMetadata}" Content="Automatically write metadata to image files" 
                                      Margin="0,0,0,5" FontWeight="Bold"
                                      ToolTip="When enabled, tags and captions will be written directly to image files (PNG tEXt chunks, JPEG/WebP EXIF)"/>
                            
                            <TextBlock TextWrapping="Wrap" Margin="0,5,0,10" Opacity="0.7" FontSize="11"
                                       Foreground="{DynamicResource ForegroundBrush}">
                                <Run Text="⚠️ Important:"/>
                                <Run Text="Enabling this will modify your original image files. Enable 'Create backup' to preserve originals as .bak files."/>
                            </TextBlock>

                            <StackPanel Margin="20,0,0,0" IsEnabled="{Binding AutoWriteMetadata}">
                                <CheckBox IsChecked="{Binding CreateMetadataBackup}" Content="Create .bak backup before modifying files" 
                                          Margin="0,0,0,5" ToolTip="Creates a backup copy (filename.ext.bak) before writing metadata"/>
                                
                                <TextBlock Text="Write to metadata:" FontWeight="SemiBold" Margin="0,10,0,5"
                                           Foreground="{DynamicResource ForegroundBrush}"/>
                                
                                <CheckBox IsChecked="{Binding WriteTagsToMetadata}" Content="Tags (comma-separated with confidence)" 
                                          Margin="0,0,0,5"/>
                                
                                <CheckBox IsChecked="{Binding WriteCaptionsToMetadata}" Content="Captions" 
                                          Margin="0,0,0,5"/>
                                
                                <CheckBox IsChecked="{Binding WriteGenerationParamsToMetadata}" Content="Generation parameters (prompt, sampler, CFG, etc.)" 
                                          Margin="0,0,0,5"/>
                            </StackPanel>

                            <TextBlock TextWrapping="Wrap" Margin="0,10,0,0" Opacity="0.7" FontSize="11"
                                       Foreground="{DynamicResource ForegroundBrush}">
                                <Run Text="Supported formats:"/>
                                <LineBreak/>
                                <Run Text="• PNG - tEXt/iTXt chunks (compatible with SD WebUI, ComfyUI)"/>
                                <LineBreak/>
                                <Run Text="• JPEG - EXIF UserComment and ImageDescription"/>
                                <LineBreak/>
                                <Run Text="• WebP - EXIF metadata"/>
                                <LineBreak/>
                                <Run Text="Note: GIF, AVIF, BMP, TIFF, and video formats do not support metadata writing."/>
                            </TextBlock>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </TabItem>
            <TabItem Header="{lex:Loc Settings.Database}">
                <StackPanel HorizontalAlignment="Left" Margin="10">
                    <GroupBox Header="Connection Info" Margin="0,0,0,10" Padding="10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="200"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Label Grid.Row="0" Grid.Column="0" Content="Host:" Foreground="{DynamicResource ForegroundBrush}"/>
                            <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Host, Mode=OneWay}" IsReadOnly="True"/>

                            <Label Grid.Row="1" Grid.Column="0" Content="Port:" Foreground="{DynamicResource ForegroundBrush}"/>
                            <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding Port, Mode=OneWay}" IsReadOnly="True"/>

                            <Label Grid.Row="2" Grid.Column="0" Content="Database:" Foreground="{DynamicResource ForegroundBrush}"/>
                            <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding Database, Mode=OneWay}" IsReadOnly="True"/>

                            <Label Grid.Row="3" Grid.Column="0" Content="Username:" Foreground="{DynamicResource ForegroundBrush}"/>
                            <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding Username, Mode=OneWay}" IsReadOnly="True"/>
                            
                            <Label Grid.Row="4" Grid.Column="0" Content="Status:" Foreground="{DynamicResource ForegroundBrush}"/>
                            <Label Grid.Row="4" Grid.Column="1" Content="{Binding Status, Mode=OneWay}" FontWeight="Bold" Foreground="{DynamicResource ForegroundBrush}"/>
                            
                            <Button Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2" Click="RefreshConnectionInfo_Click" 
                                    Width="150" Height="26" HorizontalAlignment="Left" Margin="0,10,0,0">
                                Refresh Connection
                            </Button>
                        </Grid>
                    </GroupBox>
                    
                    <GroupBox Header="Database Profiles" Margin="0,0,0,10" Padding="10">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,10" FontSize="11" Opacity="0.8"
                                       Foreground="{DynamicResource ForegroundBrush}">
                                Manage multiple database connections for different image collections (e.g., Personal Images, Luna Narrated, Test Database).
                                Switch profiles to work with different projects while using the same application.
                            </TextBlock>
                            
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Label Content="Active Profile:" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundBrush}"/>
                                <ComboBox x:Name="ProfileComboBox" Width="250" 
                                          ItemsSource="{Binding DatabaseProfiles}"
                                          SelectedValue="{Binding ActiveDatabaseProfile}"
                                          SelectedValuePath="Name"
                                          SelectionChanged="ProfileComboBox_SelectionChanged">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <Ellipse Width="10" Height="10" Margin="0,0,8,0" VerticalAlignment="Center" Fill="#808080"/>
                                                <TextBlock Text="{Binding Name}"/>
                                                <TextBlock Text="{Binding Description, StringFormat=' - {0}'}" Opacity="0.6" Margin="5,0,0,0"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>
                            
                            <StackPanel Orientation="Horizontal">
                                <Button Click="AddProfile_Click" Width="120" Height="26" Margin="0,0,5,0">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="➕" Margin="0,0,5,0"/>
                                        <TextBlock Text="Add Profile"/>
                                    </StackPanel>
                                </Button>
                                <Button Click="EditProfile_Click" Width="120" Height="26" Margin="0,0,5,0"
                                        IsEnabled="{Binding ElementName=ProfileComboBox, Path=SelectedItem, Converter={StaticResource NotNullConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="✏️" Margin="0,0,5,0"/>
                                        <TextBlock Text="Edit Profile"/>
                                    </StackPanel>
                                </Button>
                                <Button Click="DeleteProfile_Click" Width="120" Height="26"
                                        IsEnabled="{Binding ElementName=ProfileComboBox, Path=SelectedItem, Converter={StaticResource NotNullConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="🗑️" Margin="0,0,5,0"/>
                                        <TextBlock Text="Delete Profile"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                    
                    <GroupBox Header="Collection (Schema)" Margin="0,0,0,10" Padding="10">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,10" FontSize="11" Opacity="0.8"
                                       Foreground="{DynamicResource ForegroundBrush}">
                                Switch between different image collections stored in separate database schemas. Only images from the active schema will appear in the gallery.
                            </TextBlock>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Label Content="Active Schema:" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundBrush}"/>
                                <ComboBox x:Name="SchemaComboBox" Width="200" SelectedValue="{Binding DatabaseSchema}" 
                                          SelectedValuePath="Tag" SelectionChanged="SchemaComboBox_SelectionChanged">
                                    <ComboBoxItem Content="Main Collection" Tag="main"/>
                                    <ComboBoxItem Content="Public (default)" Tag="public"/>
                                    <ComboBoxItem Content="Partitioned/Datasets" Tag="partitioned"/>
                                </ComboBox>
                            </StackPanel>
                            <Button Click="CreateSchema_Click" Width="200" Height="26" HorizontalAlignment="Left">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="➕" Margin="0,0,5,0"/>
                                    <TextBlock Text="Create New Schema"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="Actions" Padding="10">
                        <StackPanel>
                            <Button Click="Backup_DB" Width="200" Height="26" Margin="0,0,0,10" Content="{lex:Loc Settings.Database.Backup}"></Button>
                            <Button Click="Restore_DB" Width="200" Height="26" Content="{lex:Loc Settings.Database.Restore}"></Button>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </TabItem>
        </TabControl>
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="160"/>
                <ColumnDefinition Width="160"/>
                <ColumnDefinition Width="160"/>
                <ColumnDefinition Width="160"/>
                <ColumnDefinition/>
            </Grid.ColumnDefinitions>
            <Label VerticalAlignment="Center" FontSize="22" FontWeight="DemiBold" Content="{lex:Loc Settings}"></Label>
            <Button Height="26" VerticalAlignment="Center" Margin="0,0,10,0" IsEnabled="{Binding IsDirty}" Click="ApplyChanges_OnClick" Grid.Column="1" Content="{lex:Loc Settings.ApplyChanges}"></Button>
            <Button Height="26" VerticalAlignment="Center" Margin="0,0,10,0" IsEnabled="{Binding IsDirty}" Click="RevertChanges_OnClick" Grid.Column="2" Content="{lex:Loc Settings.RevertChanges}"></Button>
        </Grid>
    </Grid>
</local:NavigationPage>
