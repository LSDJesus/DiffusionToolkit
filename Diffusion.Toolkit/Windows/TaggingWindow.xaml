<Window x:Class="Diffusion.Toolkit.Windows.TaggingWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:lex="http://wpflocalizeextension.codeplex.com"
        xmlns:converters="clr-namespace:Diffusion.Toolkit.Converters"
        mc:Ignorable="d"
        Title="Auto-Tag Images" Height="600" Width="600"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}">
    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
    </Window.Resources>
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0" Text="Select Processing Options" FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>

        <!-- Processing Selection -->
        <StackPanel Grid.Row="1" Margin="0,0,0,20">
            <CheckBox x:Name="AutoTagCheckBox" Content="Auto-Tag (JoyTag + WD v3 Large - Booru Tags)" 
                      IsChecked="True" Margin="0,5" FontSize="14"
                      IsEnabled="{Binding TaggingAvailable}"
                      Checked="AutoTagCheckBox_CheckedChanged" Unchecked="AutoTagCheckBox_CheckedChanged"/>
            <TextBlock Text="{Binding TaggingStatus}" Margin="25,0,0,5" 
                       Foreground="{DynamicResource TextBrush}" Opacity="0.7" FontSize="11"/>
            
            <CheckBox x:Name="JoyCaptionCheckBox" Content="JoyCaption (Natural Language Descriptions)" 
                      IsChecked="False" Margin="0,5" FontSize="14"
                      IsEnabled="{Binding JoyCaptionAvailable}"
                      Checked="JoyCaptionCheckBox_CheckedChanged" Unchecked="JoyCaptionCheckBox_CheckedChanged"/>
            <TextBlock Text="{Binding JoyCaptionStatus}" Margin="25,0,0,5" 
                       Foreground="{DynamicResource TextBrush}" Opacity="0.7" FontSize="11"/>
            
            <!-- Caption Prompt Selection (visible when JoyCaption is checked) -->
            <StackPanel x:Name="CaptionPromptPanel" Margin="25,5,0,5" 
                        Visibility="{Binding ElementName=JoyCaptionCheckBox, Path=IsChecked, Converter={StaticResource BoolToVisibilityConverter}}">
                <Label Content="Caption Style:" FontSize="11" Padding="0,0,0,3"/>
                <ComboBox Name="CaptionPromptComboBox" FontSize="12" Height="24" SelectedIndex="0">
                    <ComboBoxItem Content="Detailed Description (150-200 words)" Tag="detailed"/>
                    <ComboBoxItem Content="Short (Single sentence)" Tag="short"/>
                    <ComboBoxItem Content="Technical Analysis" Tag="technical"/>
                    <ComboBoxItem Content="Precise Colors" Tag="precise_colors"/>
                    <ComboBoxItem Content="Character Focus" Tag="character"/>
                    <ComboBoxItem Content="Scene Focus" Tag="scene"/>
                    <ComboBoxItem Content="Artistic Style" Tag="artistic"/>
                    <ComboBoxItem Content="Booru-style Tags" Tag="booru"/>
                </ComboBox>
            </StackPanel>
            
            <!-- Separator -->
            <Separator Margin="0,10,0,10" Background="{DynamicResource BorderBrush}"/>
            
            <!-- Embedding Section -->
            <CheckBox x:Name="EmbeddingCheckBox" Content="Generate Embeddings (Semantic Search + Visual Similarity)" 
                      IsChecked="{Binding EmbeddingEnabled}" Margin="0,5" FontSize="14"
                      IsEnabled="{Binding EmbeddingAvailable}"
                      Checked="EmbeddingCheckBox_CheckedChanged" Unchecked="EmbeddingCheckBox_CheckedChanged"/>
            <TextBlock Text="{Binding EmbeddingStatus}" Margin="25,0,0,5" 
                       Foreground="{DynamicResource TextBrush}" Opacity="0.7" FontSize="11"/>
            
            <!-- Face Detection Section -->
            <CheckBox x:Name="FaceDetectionCheckBox" Content="Detect Faces (Character Recognition + Clustering)" 
                      IsChecked="{Binding FaceDetectionEnabled}" Margin="0,5" FontSize="14"
                      IsEnabled="{Binding FaceDetectionAvailable}"
                      Checked="FaceDetectionCheckBox_CheckedChanged" Unchecked="FaceDetectionCheckBox_CheckedChanged"/>
            <TextBlock Text="{Binding FaceDetectionStatus}" Margin="25,0,0,5" 
                       Foreground="{DynamicResource TextBrush}" Opacity="0.7" FontSize="11"/>
        </StackPanel>

        <!-- Progress Section -->
        <StackPanel Grid.Row="2" VerticalAlignment="Center" Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="{Binding ProgressMessage}" FontSize="14" TextAlignment="Center" Margin="0,0,0,10"/>
            <ProgressBar Height="20" Minimum="0" Maximum="{Binding TotalImages}" Value="{Binding ProcessedImages}" Margin="0,0,0,10"/>
            <TextBlock FontSize="12" TextAlignment="Center" Opacity="0.7">
                <Run Text="{Binding ProcessedImages, Mode=OneWay}"/>
                <Run Text=" / "/>
                <Run Text="{Binding TotalImages, Mode=OneWay}"/>
                <Run Text=" images processed"/>
            </TextBlock>
            <TextBlock Text="{Binding CurrentImageName}" FontSize="11" TextAlignment="Center" 
                       Margin="0,5,0,0" Opacity="0.6" TextTrimming="CharacterEllipsis"/>
        </StackPanel>

        <!-- Info Section (when not processing) -->
        <StackPanel Grid.Row="2" VerticalAlignment="Center" 
                    Visibility="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <TextBlock TextAlignment="Center" FontSize="13" Opacity="0.8" TextWrapping="Wrap">
                <Run Text="{Binding ImageCount, Mode=OneWay}"/>
                <Run Text=" image(s) selected"/>
            </TextBlock>
            <TextBlock Text="Tags will be saved to the database and displayed in image metadata." 
                       TextAlignment="Center" FontSize="11" Opacity="0.6" 
                       Margin="0,10,0,0" TextWrapping="Wrap"/>
        </StackPanel>

        <!-- Buttons -->
        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
            <Button x:Name="ProcessNowButton" Content="Process Now" Width="120" Height="32" Margin="0,0,10,0"
                    Click="ProcessNow_Click" IsEnabled="{Binding CanStart}"
                    ToolTip="Add to front of queue and process with priority"/>
            <Button x:Name="AddToQueueButton" Content="Add to Queue" Width="120" Height="32" Margin="0,0,10,0"
                    Click="AddToQueue_Click" IsEnabled="{Binding CanStart}"
                    ToolTip="Add to end of background processing queue"/>
            <Button Content="Cancel" Width="100" Height="32" 
                    Click="Cancel_Click" IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
