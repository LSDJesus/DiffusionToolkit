<Window x:Class="Diffusion.Toolkit.Windows.SidecarImportWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:Diffusion.Toolkit.Converters"
        mc:Ignorable="d"
        Title="Import Sidecar .txt Files" Height="500" Width="650"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}">
    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
    </Window.Resources>
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0" Text="Import Sidecar Tags from .txt Files" FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>

        <!-- Folder Info -->
        <StackPanel Grid.Row="1" Margin="0,0,0,20">
            <TextBlock FontSize="13" Opacity="0.8">
                <Run Text="Folder:"/>
                <Run Text="{Binding FolderPath, Mode=OneWay}" FontWeight="SemiBold"/>
            </TextBlock>
            <TextBlock FontSize="12" Opacity="0.7" Margin="0,5,0,0">
                <Run Text="{Binding SidecarFileCount, Mode=OneWay}"/>
                <Run Text=" .txt sidecar file(s) found"/>
            </TextBlock>
        </StackPanel>

        <!-- Format Selection -->
        <GroupBox Grid.Row="2" Header="Sidecar File Format" Padding="10" Margin="0,0,0,20">
            <StackPanel>
                <TextBlock Text=".txt Sidecar Formats" FontWeight="Bold" Margin="0,0,0,5"/>
                
                <RadioButton x:Name="FormatCommaDelimited" Content="Comma-delimited tags (e.g., 1girl, blue_eyes, long_hair)" 
                             GroupName="Format" IsChecked="True" Margin="0,5" FontSize="13"/>
                <TextBlock Text="Tags will be stored with source based on folder path and confidence = 1.0" 
                           Margin="25,0,0,5" Opacity="0.7" FontSize="11"/>
                
                <RadioButton x:Name="FormatCommaWithConfidence" Content="Tags with confidence (e.g., cat:0.95, dog:0.88)" 
                             GroupName="Format" Margin="0,10,0,5" FontSize="13"/>
                <TextBlock Text="Format: tag:confidence or tag (confidence). Confidence scores will be preserved." 
                           Margin="25,0,0,5" Opacity="0.7" FontSize="11"/>
                
                <RadioButton x:Name="FormatPrompt" Content="Generation prompt (store in image.prompt field)" 
                             GroupName="Format" Margin="0,10,0,5" FontSize="13"/>
                <TextBlock Text="Best for JPEG files without embedded metadata - stores full prompt text" 
                           Margin="25,0,0,10" Opacity="0.7" FontSize="11"/>
                
                <Separator Margin="0,10"/>
                <TextBlock Text=".json Sidecar Format" FontWeight="Bold" Margin="0,10,0,5"/>
                
                <RadioButton x:Name="FormatDanbooruJson" Content="Danbooru JSON metadata (tags + rating)" 
                             GroupName="Format" Margin="0,5" FontSize="13"/>
                <TextBlock Text="Parses Danbooru-style JSON: tags, rating, score, artist, character, copyright" 
                           Margin="25,0,0,10" Opacity="0.7" FontSize="11"/>
                
                <Separator Margin="0,10"/>
                
                <RadioButton x:Name="FormatOther" Content="Other (store as-is in generated_tags field)" 
                             GroupName="Format" Margin="0,10,0,5" FontSize="13"/>
                <TextBlock Text="Legacy storage - full text without parsing" 
                           Margin="25,0,0,5" Opacity="0.7" FontSize="11"/>
            </StackPanel>
        </GroupBox>

        <!-- Progress Section -->
        <StackPanel Grid.Row="3" VerticalAlignment="Center" Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="{Binding ProgressMessage}" FontSize="14" TextAlignment="Center" Margin="0,0,0,10"/>
            <ProgressBar Height="20" Minimum="0" Maximum="{Binding TotalFiles}" Value="{Binding ProcessedFiles}" Margin="0,0,0,10"/>
            <TextBlock FontSize="12" TextAlignment="Center" Opacity="0.7">
                <Run Text="{Binding ProcessedFiles, Mode=OneWay}"/>
                <Run Text=" / "/>
                <Run Text="{Binding TotalFiles, Mode=OneWay}"/>
                <Run Text=" files processed"/>
            </TextBlock>
            <TextBlock Text="{Binding CurrentFileName}" FontSize="11" TextAlignment="Center" 
                       Margin="0,5,0,0" Opacity="0.6" TextTrimming="CharacterEllipsis"/>
        </StackPanel>

        <!-- Info Section (when not processing) -->
        <StackPanel Grid.Row="3" VerticalAlignment="Center" 
                    Visibility="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <TextBlock TextAlignment="Center" FontSize="12" Opacity="0.7" TextWrapping="Wrap" Margin="20">
                Select the format that matches your sidecar files. All .txt/.json files in this folder (and subfolders) will be imported according to the selected format.
            </TextBlock>
            <CheckBox x:Name="ArchiveSidecarsCheckBox" Content="Archive sidecar files after import (moves to 'archive' subfolder)" 
                      HorizontalAlignment="Center" Margin="0,10,0,0" IsChecked="True"
                      ToolTip="Moves successfully imported sidecar files to an 'archive' folder instead of deleting them"/>
        </StackPanel>

        <!-- Buttons -->
        <StackPanel Grid.Row="5" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
            <Button Content="Import" Width="100" Height="32" Margin="0,0,10,0"
                    Click="Import_Click" IsEnabled="{Binding CanImport}"/>
            <Button Content="Cancel" Width="100" Height="32" 
                    Click="Cancel_Click" IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
