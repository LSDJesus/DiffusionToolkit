<Window x:Class="Diffusion.Toolkit.Windows.MetadataExportWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:Diffusion.Toolkit.Converters"
        Title="Export Metadata to Files" 
        Height="450" 
        Width="650"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="{DynamicResource PrimaryBrush}">
    
    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
    </Window.Resources>
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Info -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="Export Database Metadata to Image Files" FontSize="16" FontWeight="Bold"/>
            <TextBlock Text="{Binding FolderPath}" Opacity="0.7" Margin="0,5,0,0"/>
            <TextBlock Opacity="0.7" Margin="0,5,0,0">
                <Run Text="Found"/>
                <Run Text="{Binding ImageCount, Mode=OneWay}" FontWeight="Bold"/>
                <Run Text="images with metadata in database"/>
            </TextBlock>
        </StackPanel>

        <!-- Export Options -->
        <GroupBox Grid.Row="1" Header="Export Options" Padding="10" Margin="0,0,0,20">
            <StackPanel>
                <CheckBox IsChecked="{Binding ExportTags}" Content="Export tags (from image_tags table)" Margin="0,0,0,5"/>
                <TextBlock Text="Tags will be written as comma-separated list with confidence scores" 
                           Margin="25,0,0,5" Opacity="0.7" FontSize="11"/>
                
                <CheckBox IsChecked="{Binding ExportCaptions}" Content="Export captions (from image_captions table)" Margin="0,5,0,5"/>
                <TextBlock Text="Most recent caption per image will be written to metadata" 
                           Margin="25,0,0,5" Opacity="0.7" FontSize="11"/>
                
                <CheckBox IsChecked="{Binding ExportGenerationParams}" Content="Export generation parameters (prompt, sampler, etc.)" Margin="0,5,0,5"/>
                <TextBlock Text="Writes SD WebUI-compatible parameters string from image table" 
                           Margin="25,0,0,10" Opacity="0.7" FontSize="11"/>
                
                <Separator Margin="0,10"/>
                
                <CheckBox IsChecked="{Binding CreateBackup}" Content="Create .bak backup before modifying files" Margin="0,5,0,5"/>
                <TextBlock Text="⚠️ Original files will be modified! Backup recommended." 
                           Margin="0,5,0,0" Foreground="Orange" FontSize="11"/>
            </StackPanel>
        </GroupBox>

        <!-- Filter Options -->
        <GroupBox Grid.Row="2" Header="Filter" Padding="10" Margin="0,0,0,20">
            <StackPanel>
                <RadioButton x:Name="FilterAll" Content="Export to all images in folder" GroupName="Filter" IsChecked="True" Margin="0,0,0,5"/>
                <RadioButton x:Name="FilterPngJpegWebp" Content="Export only to PNG, JPEG, WebP (skip other formats)" GroupName="Filter" Margin="0,0,0,5"/>
                <TextBlock Text="Note: Only PNG, JPEG, and WebP support metadata writing. Other formats will be skipped automatically." 
                           Margin="0,5,0,0" Opacity="0.7" FontSize="11"/>
            </StackPanel>
        </GroupBox>

        <!-- Progress Section -->
        <StackPanel Grid.Row="3" VerticalAlignment="Center" Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="{Binding ProgressMessage}" FontSize="14" TextAlignment="Center" Margin="0,0,0,10"/>
            <ProgressBar Height="20" Minimum="0" Maximum="{Binding TotalFiles}" Value="{Binding ProcessedFiles}" Margin="0,0,0,10"/>
            <TextBlock TextAlignment="Center" Opacity="0.7">
                <Run Text="{Binding ProcessedFiles, Mode=OneWay}"/>
                <Run Text="/"/>
                <Run Text="{Binding TotalFiles, Mode=OneWay}"/>
                <Run Text="files processed"/>
            </TextBlock>
            <TextBlock Text="{Binding CurrentFileName}" TextAlignment="Center" Opacity="0.7" Margin="0,5,0,0" FontSize="11"/>
        </StackPanel>

        <!-- Buttons -->
        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Content="Export" Width="100" Height="32" 
                    Click="Export_Click"
                    IsEnabled="{Binding CanExport}"
                    Visibility="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
            <Button Content="Cancel" Width="100" Height="32" Margin="10,0,0,0" 
                    Click="Cancel_Click"/>
        </StackPanel>
    </Grid>
</Window>
